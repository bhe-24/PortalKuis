<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sertifikat & Hasil - Cendekia Aksara</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="stylesheet" href="css/style.css">

    <style>
        body { background-color: #f0f2f5; min-height: 100vh; padding: 20px; font-family: 'Poppins', sans-serif; }

        /* LAYOUT UTAMA: 2 KOLOM (Laptop) */
        .main-layout {
            display: flex; gap: 30px; justify-content: center; align-items: flex-start;
            max-width: 1200px; margin: 0 auto;
        }

        /* --- KOLOM KIRI: HASIL NILAI --- */
        .result-column { flex: 1; max-width: 400px; }

        .result-card {
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; padding-bottom: 30px;
        }
        .card-header-bg {
            height: 100px; background: linear-gradient(135deg, #005a9c, #4facfe); position: relative;
        }
        .score-circle {
            width: 120px; height: 120px; background: white; border-radius: 50%;
            margin: -60px auto 15px auto; position: relative; z-index: 2;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 5px solid #f8f9fa;
        }
        .score-val { font-size: 3em; font-weight: 700; color: #005a9c; line-height: 1; }
        .score-label { font-size: 0.7em; color: #777; text-transform: uppercase; }
        .status-badge { display: inline-block; padding: 5px 20px; border-radius: 50px; font-weight: 600; font-size: 0.85em; margin-bottom: 10px; }
        .status-lulus { background: #e6f7ec; color: #28a745; }
        .status-remed { background: #fdeeee; color: #dc3545; }
        
        /* Tombol */
        .btn-full {
            width: 100%; padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s;
            margin-bottom: 10px; border: none; font-size: 0.9em;
        }
        .btn-gold { background: linear-gradient(135deg, #d4af37, #f1c40f); color: white; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .btn-blue { background: #005a9c; color: white; }
        .btn-outline { background: white; border: 1px solid #ddd; color: #555; }
        .btn-full:hover { transform: translateY(-2px); opacity: 0.9; }


        /* --- KOLOM KANAN: PREVIEW SERTIFIKAT (A5 LANDSCAPE) --- */
        .cert-column { 
            flex: 2; display: flex; justify-content: center; align-items: center; 
            perspective: 1000px;
        }

        /* Canvas Sertifikat (Ukuran Fix A5 Landscape: 210mm x 148mm -> approx 800px width) */
        #certificate-node {
            width: 800px; height: 565px; /* Rasio A5 */
            background: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border: 1px solid #ddd;
            display: flex; flex-direction: column; align-items: center;
        }

        /* DESAIN SERTIFIKAT (CSS ONLY) */
        .cert-border-outer {
            position: absolute; top: 15px; left: 15px; right: 15px; bottom: 15px;
            border: 2px solid #d4af37; /* Emas */
            z-index: 1; pointer-events: none;
        }
        
        /* Hiasan Sudut */
        .corner-deco-tl {
            position: absolute; top: 0; left: 0;
            width: 150px; height: 150px;
            background: #1e3a5f;
            border-bottom-right-radius: 100%;
            z-index: 0;
        }
        .corner-deco-br {
            position: absolute; bottom: 0; right: 0;
            width: 120px; height: 120px;
            background: #d4af37;
            border-top-left-radius: 100%;
            opacity: 0.3;
            z-index: 0;
        }
        .corner-line-tr {
            position: absolute; top: 20px; right: 20px;
            width: 100px; height: 100px;
            border-top: 5px solid #d4af37;
            border-right: 5px solid #d4af37;
            z-index: 1;
        }

        /* Konten Teks Sertifikat */
        .cert-content {
            z-index: 2; text-align: center; width: 80%;
            margin-top: 60px;
        }
        .cert-title {
            font-family: 'Cinzel', serif;
            font-size: 3.5em; color: #1e3a5f; letter-spacing: 5px;
            margin: 0; font-weight: 700; text-transform: uppercase;
        }
        .cert-subtitle {
            font-family: 'Poppins', sans-serif; font-size: 1.2em;
            color: #555; margin-top: 10px; letter-spacing: 2px;
        }

        /* NAMA SISWA (Latin/Cursive) */
        .cert-name {
            font-family: 'Great Vibes', cursive;
            font-size: 4.5em; color: #d4af37; /* Emas */
            margin: 10px 0 20px 0;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
            line-height: 1.2;
            min-height: 80px; /* Jaga tinggi agar tidak gepeng */
        }

        .cert-body {
            font-family: 'Poppins', sans-serif; font-size: 0.9em; color: #666;
            line-height: 1.6; max-width: 600px; margin: 0 auto;
        }

        /* Footer Tanda Tangan */
        .cert-footer {
            position: absolute; bottom: 40px; width: 80%;
            display: flex; justify-content: space-between; align-items: flex-end;
            z-index: 2;
        }
        .sign-box { text-align: center; position: relative; width: 200px; }
        .sign-line { border-top: 1px solid #333; margin-top: 60px; padding-top: 5px; font-weight: 700; color: #1e3a5f; }
        .sign-role { font-size: 0.8em; color: #777; }
        
        /* Cap Basah */
        .stamp-img {
            position: absolute; top: -40px; left: 50%; 
            transform: translateX(-50%) rotate(-10deg);
            width: 120px; opacity: 0.9;
            z-index: 5; /* Z-index tinggi agar muncul di atas */
        }

        /* LOGO DI SERTIFIKAT */
        .cert-logo {
            position: absolute; top: 40px; right: 40px; width: 60px; opacity: 0.8;
            z-index: 5;
        }

        @media (max-width: 900px) {
            .main-layout { flex-direction: column; align-items: center; }
            .result-column { width: 100%; max-width: 100%; }
            .cert-column { display: none; } 
            #certificate-hidden-wrapper { position: absolute; left: -9999px; top: -9999px; }
        }
        
        .visible-on-mobile-render { display: flex !important; }

    </style>
</head>
<body>

    <div class="main-layout">
        
        <div class="result-column">
            <div class="result-card">
                <div class="card-header-bg">
                    <div style="padding-top: 20px; color: white; font-weight: 600;">
                        <i class="fa-solid fa-graduation-cap"></i> Hasil Ujian
                    </div>
                </div>

                <div class="score-circle">
                    <span id="display-score" class="score-val">0</span>
                    <span class="score-label">Nilai Akhir</span>
                </div>

                <div id="status-badge" class="status-badge status-lulus">MEMUAT...</div>
                
                <h3 id="res-quiz-title" style="margin: 10px 0 5px 0; color:#333;">...</h3>
                <p id="res-student-name" style="color:#777; font-size:0.9em; margin-bottom:20px;">...</p>

                <div style="padding: 0 20px;">
                    <button onclick="downloadCertificate()" class="btn-full btn-gold">
                        <i class="fa-solid fa-certificate"></i> Unduh Sertifikat (JPG)
                    </button>
                    
                    <button onclick="downloadPDF()" class="btn-full btn-blue">
                        <i class="fa-solid fa-file-pdf"></i> Unduh Arsip Soal (PDF)
                    </button>
                    
                    <button onclick="window.location.href='dashboard.html'" class="btn-full btn-outline">
                        Kembali ke Dashboard
                    </button>
                </div>
            </div>
        </div>

        <div class="cert-column" id="cert-preview-container">
            <div id="certificate-node">
                <div class="corner-deco-tl"></div>
                <div class="corner-deco-br"></div>
                <div class="corner-line-tr"></div>
                <div class="cert-border-outer"></div>
                
                <img src="https://imgur.com/5Srjyo4.png" class="cert-logo" alt="Logo" crossorigin="anonymous">

                <div class="cert-content">
                    <h1 class="cert-title">SERTIFIKAT</h1>
                    <div class="cert-subtitle">PENGHARGAAN PRESTASI</div>
                    
                    <p style="margin-top:20px; color:#555;">Diberikan dengan bangga kepada:</p>
                    
                    <div id="cert-student-name" class="cert-name">Nama Siswa</div>
                    
                    <div class="cert-body">
                        Atas kelulusannya dalam menyelesaikan ujian kompetensi<br>
                        <strong id="cert-quiz-name" style="color:#1e3a5f; font-size:1.1em;">Nama Kuis Disini</strong><br>
                        dengan predikat <strong id="cert-grade" style="color:#d4af37;">SANGAT BAIK</strong>.
                    </div>
                </div>

                <div class="cert-footer">
                    <div class="sign-box" style="text-align: left;">
                        <p id="cert-date" style="margin-bottom: 5px; font-size:0.9em;">Yogyakarta, 20 Mei 2024</p>
                    </div>

                    <div class="sign-box">
                        <img src="https://imgur.com/YvrNYRw.png" class="stamp-img" alt="Stamp" crossorigin="anonymous">
                        
                        <div class="sign-line">Cendekia Aksara</div>
                        <div class="sign-role">Panitia Ujian</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="mobile-render-helper" style="position:fixed; left:-9999px; top:0;"></div>

    <script src="js/config.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const paramQid = urlParams.get('qid');

        let globalQuizData = null;
        let globalSubmissionData = null;

        auth.onAuthStateChanged(async user => {
            if (!user) { window.location.href = 'index.html'; return; }
            if(!paramQid) { window.location.href = 'dashboard.html'; return; }

            if(typeof showLoading === 'function') showLoading();

            try {
                // 1. AMBIL NAMA ASLI DARI DATABASE USER (Fix Nama Tidak Muncul)
                // Kita tidak percaya pada user.displayName, kita ambil dari koleksi 'users'
                let realStudentName = user.displayName;
                const userDoc = await db.collection('users').doc(user.uid).get();
                if(userDoc.exists && userDoc.data().name) {
                    realStudentName = userDoc.data().name;
                }

                // 2. Ambil Data Nilai
                const subQuery = await db.collection('quiz_submissions')
                    .where('studentUid', '==', user.uid)
                    .where('quizId', '==', paramQid)
                    .get();

                if (subQuery.empty) throw new Error("Data ujian tidak ditemukan.");

                // Sorting Manual
                let submissions = [];
                subQuery.forEach(doc => submissions.push(doc.data()));
                submissions.sort((a, b) => (b.submittedAt?.seconds || 0) - (a.submittedAt?.seconds || 0));
                
                globalSubmissionData = submissions[0];

                // 3. Ambil Data Kuis
                const quizDoc = await db.collection('quizzes').doc(paramQid).get();
                if (!quizDoc.exists) throw new Error("Data soal kuis hilang.");
                globalQuizData = quizDoc.data();

                // 4. Render dengan Nama yang Benar
                updateUI(globalSubmissionData, realStudentName);

            } catch (err) {
                console.error(err);
                alert("Gagal: " + err.message);
            } finally {
                if(typeof hideLoading === 'function') hideLoading();
            }
        });

        function updateUI(data, userName) {
            // Prioritaskan Nama dari Database User -> Nama di Submission -> Default
            const finalName = userName || data.studentName || "Siswa Cendekia";
            
            document.getElementById('display-score').textContent = data.score;
            document.getElementById('res-quiz-title').textContent = data.quizTitle;
            document.getElementById('res-student-name').textContent = finalName;

            const badge = document.getElementById('status-badge');
            let predikat = "BAIK";
            
            if (data.score >= 85) {
                badge.className = "status-badge status-lulus"; badge.textContent = "LULUS (A)"; predikat = "SANGAT MEMUASKAN";
            } else if (data.score >= 70) {
                badge.className = "status-badge status-lulus"; badge.textContent = "LULUS (B)"; predikat = "BAIK";
            } else {
                badge.className = "status-badge status-remed"; badge.textContent = "REMEDIAL"; predikat = "CUKUP";
            }

            // Update Sertifikat
            document.getElementById('cert-student-name').textContent = finalName;
            document.getElementById('cert-quiz-name').textContent = data.quizTitle;
            document.getElementById('cert-grade').textContent = predikat;
            
            const dateObj = data.submittedAt ? data.submittedAt.toDate() : new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('cert-date').textContent = "Yogyakarta, " + dateObj.toLocaleDateString('id-ID', options);
        }

        // --- DOWNLOAD SERTIFIKAT (JPG) ---
        function downloadCertificate() {
            const certNode = document.getElementById('certificate-node');
            const mobileWrapper = document.getElementById('mobile-render-helper');
            const previewContainer = document.getElementById('cert-preview-container');
            
            const isMobile = window.getComputedStyle(previewContainer).display === 'none';
            if (isMobile) mobileWrapper.appendChild(certNode);

            if(typeof showLoading === 'function') showLoading();

            // PENTING: useCORS: true agar gambar dari imgur bisa di-render
            html2canvas(certNode, { scale: 2, useCORS: true, allowTaint: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Sertifikat_${globalSubmissionData.quizTitle}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
                
                if (isMobile) previewContainer.appendChild(certNode);
                if(typeof hideLoading === 'function') hideLoading();
            }).catch(err => {
                console.error(err);
                if(typeof hideLoading === 'function') hideLoading();
                alert("Gagal mencetak. Pastikan koneksi lancar.");
                if (isMobile) previewContainer.appendChild(certNode);
            });
        }

        // --- DOWNLOAD PDF SOAL ---
        async function downloadPDF() {
            if (!globalQuizData || !globalSubmissionData) return alert("Data belum siap.");
            if(typeof showLoading === 'function') showLoading();

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const margin = 15;
                let y = 20; const pageWidth = doc.internal.pageSize.getWidth();

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(0, 90, 156);
                doc.text("ARSIP HASIL UJIAN", pageWidth/2, y, {align:'center'});
                y += 15;
                
                doc.setFontSize(10); doc.setTextColor(0); doc.setFont('helvetica', 'normal');
                doc.text(`Nama: ${globalSubmissionData.studentName || 'Siswa'}`, margin, y); y+=5;
                doc.text(`Kuis: ${globalQuizData.title}`, margin, y); y+=5;
                doc.text(`Nilai: ${globalSubmissionData.score}`, margin, y); y+=10;
                doc.line(margin, y, pageWidth-margin, y); y+=10;

                const questions = globalQuizData.questions;
                const userAns = globalSubmissionData.answers || {};

                questions.forEach((q, index) => {
                    const studentChoice = userAns[index];
                    const correctChoice = parseInt(q.correctAnswerIndex);
                    
                    if (y > 270) { doc.addPage(); y = 20; }
                    
                    doc.setFont('helvetica', 'bold');
                    const qText = `${index + 1}. ${q.questionText.replace(/<[^>]*>?/gm, '')}`;
                    const splitTitle = doc.splitTextToSize(qText, pageWidth-(margin*2));
                    doc.text(splitTitle, margin, y);
                    y += (splitTitle.length * 5) + 3;

                    doc.setFont('helvetica', 'normal');
                    q.options.forEach((opt, i) => {
                        let prefix = (i === studentChoice) ? "(x) " : "( ) ";
                        let color = [0,0,0];
                        if (i === correctChoice) { color = [0,150,0]; prefix="(KUNCI) "; }
                        if (i === studentChoice && i !== correctChoice) { color = [200,0,0]; prefix="(JAWABANMU) "; }
                        
                        doc.setTextColor(color[0], color[1], color[2]);
                        const optText = doc.splitTextToSize(`${String.fromCharCode(65+i)}. ${opt}`, pageWidth-(margin*2)-10);
                        doc.text(prefix, margin+2, y);
                        doc.text(optText, margin+25, y);
                        y += (optText.length * 5) + 1;
                    });
                    doc.setTextColor(0); y+=5;
                });
                
                doc.save(`Arsip_${globalQuizData.title}.pdf`);
            } catch (err) { console.error(err); alert("PDF Error"); }
            finally { if(typeof hideLoading === 'function') hideLoading(); }
        }
    </script>
</body>
</html>
