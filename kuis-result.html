<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Ujian - Cendekia Aksara</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <link rel="stylesheet" href="css/style.css">

    <style>
        body { background-color: #f0f2f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; font-family: 'Poppins', sans-serif; }

        .result-container {
            width: 100%; max-width: 500px;
            text-align: center;
        }

        /* --- KARTU HASIL --- */
        .result-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            text-align: center;
            padding-bottom: 30px;
        }

        /* Hiasan Header */
        .card-header-bg {
            height: 120px;
            background: linear-gradient(135deg, #005a9c, #4facfe); /* Biru Cendekia */
            position: relative;
        }
        .card-header-bg::after {
            content: ''; position: absolute; bottom: -20px; left: 0; right: 0;
            height: 40px; background: white; border-radius: 50% 50% 0 0;
        }

        /* Skor Besar */
        .score-circle {
            width: 140px; height: 140px;
            background: white; border-radius: 50%;
            margin: -70px auto 15px auto;
            position: relative; z-index: 2;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border: 5px solid #f8f9fa;
        }
        .score-val { font-size: 3.5em; font-weight: 700; color: #005a9c; line-height: 1; }
        .score-label { font-size: 0.8em; color: #777; text-transform: uppercase; letter-spacing: 1px; }

        /* Detail Teks */
        .result-title { font-size: 1.2em; font-weight: 700; color: #333; margin: 0; padding: 0 20px; }
        .result-subtitle { color: #666; font-size: 0.9em; margin-top: 5px; margin-bottom: 20px; padding: 0 20px; }

        /* Grid Statistik Kecil */
        .mini-stats {
            display: flex; justify-content: center; gap: 30px;
            margin: 20px 0; padding: 0 20px;
        }
        .ms-item { text-align: center; }
        .ms-val { font-weight: 700; color: #333; font-size: 1.1em; }
        .ms-label { font-size: 0.75em; color: #888; }

        /* Status Badge */
        .status-badge {
            display: inline-block; padding: 8px 25px; border-radius: 50px;
            font-weight: 600; font-size: 0.9em; margin-bottom: 10px;
        }
        .status-lulus { background: #e6f7ec; color: #28a745; }
        .status-remed { background: #fdeeee; color: #dc3545; }

        /* Area Tombol */
        .action-area { margin-top: 30px; display: flex; flex-direction: column; gap: 10px; }
        
        .btn-img { background: #333; color: white; border: none; }
        .btn-pdf { background: white; color: #d32f2f; border: 1px solid #d32f2f; }
        .btn-home { background: transparent; color: #555; text-decoration: underline; margin-top: 10px; cursor: pointer; border: none; }

        .btn-full {
            padding: 12px; border-radius: 10px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-full:hover { opacity: 0.9; transform: translateY(-2px); }

    </style>
</head>
<body>

    <div class="result-container">
        
        <div id="result-card" class="result-card">
            
            <div class="card-header-bg">
                <div style="padding-top: 20px; color: white; font-weight: 600; font-size: 1.1em;">
                    <i class="fa-solid fa-graduation-cap"></i> Cendekia Aksara
                </div>
            </div>

            <div class="score-circle">
                <span id="display-score" class="score-val">0</span>
                <span class="score-label">Nilai Akhir</span>
            </div>

            <div id="status-badge" class="status-badge status-lulus">MEMUAT HASIL...</div>

            <h2 id="quiz-title" class="result-title">...</h2>
            <p id="student-name" class="result-subtitle">...</p>

            <div class="mini-stats">
                <div class="ms-item">
                    <div id="val-correct" class="ms-val">0</div>
                    <div class="ms-label">Benar</div>
                </div>
                <div class="ms-item">
                    <div id="val-wrong" class="ms-val">0</div>
                    <div class="ms-label">Salah</div>
                </div>
                <div class="ms-item">
                    <div id="val-date" class="ms-val">-</div>
                    <div class="ms-label">Tanggal</div>
                </div>
            </div>

            <div style="font-size: 0.7em; color: #bbb; margin-top: 10px;">
                Terverifikasi Otomatis oleh Sistem
            </div>
        </div>

        <div class="action-area">
            <button onclick="downloadImage()" class="btn-full btn-img">
                <i class="fa-solid fa-image"></i> Simpan Kartu Hasil (JPG)
            </button>
            
            <button onclick="downloadPDF()" class="btn-full btn-pdf">
                <i class="fa-solid fa-file-pdf"></i> Unduh Arsip Soal (PDF)
            </button>
            
            <button onclick="window.location.href='dashboard.html'" class="btn-home">
                Kembali ke Dashboard
            </button>
        </div>

    </div>

    <script src="js/config.js"></script>
    <script>
        // Ambil Parameter dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const paramQid = urlParams.get('qid'); // ID Kuis

        // Data Global untuk PDF
        let globalQuizData = null;
        let globalSubmissionData = null;

        auth.onAuthStateChanged(async user => {
            if (!user) { window.location.href = 'index.html'; return; }
            
            if(!paramQid) {
                alert("Data hasil tidak ditemukan.");
                window.location.href = 'dashboard.html';
                return;
            }

            // Panggil Loading
            if(typeof showLoading === 'function') showLoading();

            try {
                // === PERBAIKAN: HAPUS .orderBy() AGAR TIDAK BUTUH INDEX FIREBASE ===
                const subQuery = await db.collection('quiz_submissions')
                    .where('studentUid', '==', user.uid)
                    .where('quizId', '==', paramQid)
                    .get();

                if (subQuery.empty) {
                    throw new Error("Data ujian tidak ditemukan di database.");
                }

                // Kita Urutkan Manual di Sini (Ambil yang paling baru)
                let submissions = [];
                subQuery.forEach(doc => submissions.push(doc.data()));
                
                // Sort Descending (Terbaru di atas) berdasarkan submittedAt
                submissions.sort((a, b) => {
                    const dateA = a.submittedAt ? a.submittedAt.seconds : 0;
                    const dateB = b.submittedAt ? b.submittedAt.seconds : 0;
                    return dateB - dateA;
                });

                // Ambil yang pertama (terbaru)
                globalSubmissionData = submissions[0];

                // 2. AMBIL DATA SOAL KUIS (Untuk PDF)
                const quizDoc = await db.collection('quizzes').doc(paramQid).get();
                if (!quizDoc.exists) throw new Error("Data soal kuis hilang.");
                globalQuizData = quizDoc.data();

                // 3. RENDER KARTU HASIL
                renderResultCard(globalSubmissionData, user.displayName);

            } catch (err) {
                console.error("Error Detail:", err);
                alert("Gagal memuat: " + err.message);
            } finally {
                if(typeof hideLoading === 'function') hideLoading();
            }
        });

        function renderResultCard(data, userName) {
            // Isi Data Kartu
            document.getElementById('display-score').textContent = data.score;
            document.getElementById('quiz-title').textContent = data.quizTitle;
            document.getElementById('student-name').textContent = userName || "Siswa Cendekia";
            
            // Hitung Salah
            const wrong = data.totalQuestions - data.correctCount;
            document.getElementById('val-correct').textContent = data.correctCount;
            document.getElementById('val-wrong').textContent = wrong;

            // Tanggal
            const date = data.submittedAt ? data.submittedAt.toDate().toLocaleDateString('id-ID') : '-';
            document.getElementById('val-date').textContent = date;

            // Status Lulus/Tidak
            const badge = document.getElementById('status-badge');
            if (data.score >= 70) {
                badge.textContent = "LULUS / KOMPETEN";
                badge.className = "status-badge status-lulus";
            } else {
                badge.textContent = "REMEDIAL";
                badge.className = "status-badge status-remed";
            }
        }

        // --- FITUR DOWNLOAD GAMBAR ---
        function downloadImage() {
            const card = document.getElementById('result-card');
            if(typeof showLoading === 'function') showLoading();

            html2canvas(card, { scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Hasil_${globalSubmissionData.quizTitle}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                if(typeof hideLoading === 'function') hideLoading();
            }).catch(err => {
                if(typeof hideLoading === 'function') hideLoading();
                alert("Gagal membuat gambar.");
            });
        }

        // --- FITUR DOWNLOAD PDF ---
        async function downloadPDF() {
            if (!globalQuizData || !globalSubmissionData) {
                alert("Data belum siap. Tunggu sebentar...");
                return;
            }

            if(typeof showLoading === 'function') showLoading();

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const margin = 15;
                const pageWidth = doc.internal.pageSize.getWidth();
                let y = 20;

                // HEADER
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(0, 90, 156);
                doc.text("ARSIP HASIL UJIAN", pageWidth / 2, y, { align: 'center' });
                y += 10;

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.text(`Nama: ${globalSubmissionData.studentName || 'Siswa'}`, margin, y);
                y += 6;
                doc.text(`Kuis: ${globalQuizData.title}`, margin, y);
                y += 6;
                doc.text(`Nilai: ${globalSubmissionData.score} (${globalSubmissionData.score >= 70 ? 'Lulus' : 'Remedial'})`, margin, y);
                
                y += 10;
                doc.setDrawColor(200);
                doc.line(margin, y, pageWidth - margin, y);
                y += 10;

                // CONTENT SOAL
                const questions = globalQuizData.questions;
                const userAns = globalSubmissionData.answers || {};

                questions.forEach((q, index) => {
                    const studentChoice = userAns[index];
                    const correctChoice = parseInt(q.correctAnswerIndex);

                    if (y > 270) { doc.addPage(); y = 20; }

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    const qText = `${index + 1}. ${q.questionText.replace(/<[^>]*>?/gm, '')}`;
                    const splitTitle = doc.splitTextToSize(qText, pageWidth - (margin * 2));
                    doc.text(splitTitle, margin, y);
                    y += (splitTitle.length * 5) + 3;

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    
                    q.options.forEach((opt, i) => {
                        let prefix = (i === studentChoice) ? "(x) " : "( ) ";
                        let color = [0, 0, 0];

                        if (i === correctChoice) {
                            color = [0, 150, 0]; 
                            prefix = "(KUNCI) ";
                        } 
                        if (i === studentChoice && i !== correctChoice) {
                            color = [200, 0, 0];
                            prefix = "(JAWABANMU) ";
                        }

                        doc.setTextColor(color[0], color[1], color[2]);
                        const optText = `${String.fromCharCode(65+i)}. ${opt}`;
                        const splitOpt = doc.splitTextToSize(prefix + optText, pageWidth - (margin * 2) - 10);
                        
                        doc.text(splitOpt, margin + 5, y);
                        y += (splitOpt.length * 5) + 1;
                    });
                    
                    doc.setTextColor(0,0,0);
                    y += 5;
                });

                doc.save(`Arsip_${globalQuizData.title}.pdf`);

            } catch (err) {
                console.error(err);
                alert("Gagal membuat PDF: " + err.message);
            } finally {
                if(typeof hideLoading === 'function') hideLoading();
            }
        }
    </script>
</body>
</html>
