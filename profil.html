<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - Cendekia Aksara</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* CSS KHUSUS HALAMAN PROFIL */
        
        /* Layout Grid: Kiri Avatar, Kanan Form */
        .profile-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            padding: 40px;
            display: flex;
            gap: 40px;
            align-items: flex-start;
            margin-top: 20px;
        }

        /* Bagian Avatar (Kiri) */
        .avatar-section {
            flex: 1; /* Lebar 1 bagian */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avatar-box {
            width: 180px; height: 180px;
            border-radius: 50%;
            overflow: hidden;
            border: 5px solid #f0f0f0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            background-color: #e3f2fd;
            transition: 0.3s;
        }
        
        .avatar-box:hover { border-color: var(--primary); transform: scale(1.05); }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }

        .role-badge {
            background: var(--primary); color: white;
            padding: 5px 15px; border-radius: 50px;
            font-size: 0.9em; font-weight: 600;
            margin-top: 10px; display: inline-block;
        }

        /* Bagian Form (Kanan) */
        .form-section {
            flex: 2; /* Lebar 2 bagian (lebih luas) */
        }

        /* Label Form yang lebih rapi */
        .form-group label {
            font-size: 0.9em; color: #666; font-weight: 500;
        }

        .alert-box {
            background: #fff3cd; color: #856404;
            padding: 15px; border-radius: 10px;
            border: 1px solid #ffeeba;
            margin-bottom: 20px;
            font-size: 0.9em; display: flex; align-items: center; gap: 10px;
        }

        /* RESPONSIF HP: Avatar Pindah ke Atas */
        @media (max-width: 768px) {
            .profile-container {
                flex-direction: column; /* Tumpuk ke bawah */
                padding: 25px;
            }
            .avatar-section {
                width: 100%; margin-bottom: 20px;
                border-bottom: 1px solid #eee; padding-bottom: 20px;
            }
            .avatar-box { width: 140px; height: 140px; }
            .form-section { width: 100%; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="nav-brand">
                <img src="https://imgur.com/5Srjyo4.png" alt="Logo" class="nav-logo">
                <span class="brand-name">Cendekia Aksara</span>
            </div>
            <a href="dashboard.html" class="btn-logout" style="color: #333; border-color: #ddd;">
                <i class="fa-solid fa-arrow-left"></i> Kembali
            </a>
        </div>
    </nav>

    <div class="container dashboard-content">
        <div class="welcome-banner" style="background: linear-gradient(135deg, #43e97b, #38f9d7); padding: 30px;">
            <div class="welcome-text">
                <h1 style="margin: 0;">Profil Saya</h1>
                <p class="subtitle" style="color: #005a9c; opacity: 1;">Kelola data diri agar tetap update.</p>
            </div>
            <div class="welcome-icon"><i class="fa-solid fa-id-card-clip" style="color: rgba(255,255,255,0.4);"></i></div>
        </div>

        <div class="profile-container">
            
            <div class="avatar-section">
                <div class="avatar-box">
                    <img id="avatar-img" src="https://api.dicebear.com/7.x/bottts/svg?seed=neutral" alt="Avatar">
                </div>
                <h3 id="display-name" style="margin: 0;">Siswa</h3>
                <span id="display-role" class="role-badge">SISWA</span>
                <p style="font-size: 0.8em; color: gray; margin-top: 10px;">Avatar otomatis menyesuaikan jenis kelamin.</p>
            </div>

            <div class="form-section">
                
                <div id="incomplete-alert" class="alert-box hidden">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span><strong>Perhatian!</strong> Harap lengkapi Jenis Kelamin, Umur, dan Kelas.</span>
                </div>

                <form id="profile-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Email (Akun)</label>
                            <input type="email" id="p-email" class="modal-input-field" disabled style="background:#f9f9f9; cursor:not-allowed;">
                        </div>
                        <div class="form-group">
                            <label>Nama Lengkap</label>
                            <input type="text" id="p-name" class="modal-input-field" required>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px dashed #ddd; margin: 10px 0 20px 0;">

                    <div class="form-group">
                        <label>Jenis Kelamin <span style="color:red">*</span></label>
                        <select id="p-gender" class="modal-input-field" required onchange="updateAvatar(this.value)">
                            <option value="" disabled selected>-- Pilih Jenis Kelamin --</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Umur (Tahun) <span style="color:red">*</span></label>
                            <input type="number" id="p-age" class="modal-input-field" placeholder="Contoh: 16" required min="5" max="99">
                        </div>
                        <div class="form-group">
                            <label>Kelas / Tingkat <span style="color:red">*</span></label>
                            <input type="text" id="p-class" class="modal-input-field" placeholder="Contoh: XII IPA 1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Alamat / Kota</label>
                        <input type="text" id="p-address" class="modal-input-field" placeholder="Contoh: Jakarta Selatan">
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top: 10px; width: 100%;">
                        <i class="fa-solid fa-floppy-disk"></i> SIMPAN PERUBAHAN
                    </button>
                </form>
            </div>

        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let uid = null;
        
        // Cek Login & Ambil Data
        auth.onAuthStateChanged(async user => {
            if(!user) { window.location.href = 'index.html'; return; }
            uid = user.uid;
            
            showLoading(); // Efek Blur Loading

            try {
                const doc = await db.collection('users').doc(uid).get();
                if(doc.exists) {
                    const data = doc.data();
                    
                    // Isi Form dari Database
                    document.getElementById('p-email').value = data.email || '';
                    document.getElementById('p-name').value = data.name || '';
                    document.getElementById('p-role').textContent = (data.role || 'SISWA').toUpperCase();
                    document.getElementById('display-name').textContent = data.name || 'Siswa';

                    // Isi Data Tambahan (Jika ada)
                    if(data.gender) document.getElementById('p-gender').value = data.gender;
                    if(data.age) document.getElementById('p-age').value = data.age;
                    if(data.class_room) document.getElementById('p-class').value = data.class_room; // class_room biar beda sama keyword class JS
                    if(data.address) document.getElementById('p-address').value = data.address;

                    // Update Avatar sesuai data gender
                    updateAvatar(data.gender);

                    // CEK DATA WAJIB: Jika kosong, munculkan Pop-up Peringatan
                    if (!data.gender || !data.age || !data.class_room) {
                        document.getElementById('incomplete-alert').classList.remove('hidden');
                        
                        // POP UP BLUR WAJIB ISI
                        await showAlert(
                            "Data Belum Lengkap", 
                            "Halo! Mohon lengkapi data <b>Jenis Kelamin, Umur, dan Kelas</b> sebelum melanjutkan aktivitas.", 
                            "info"
                        );
                    }
                }
            } catch (err) {
                console.error(err);
                showAlert("Error", "Gagal memuat profil.", "error");
            } finally {
                hideLoading();
            }
        });

        // Fungsi Ganti Kartun Avatar (Dipanggil saat Load & saat Pilih Gender)
        function updateAvatar(gender) {
            const imgEl = document.getElementById('avatar-img');
            let seed = uid ? uid.substring(0, 5) : 'random'; // Biar gambarnya konsisten per user
            
            if (gender === 'Laki-laki') {
                // Kartun Cowok
                imgEl.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&gender=male&style=circle`;
            } else if (gender === 'Perempuan') {
                // Kartun Cewek
                imgEl.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&gender=female&style=circle`;
            } else {
                // Netral (Robot Lucu)
                imgEl.src = `https://api.dicebear.com/7.x/bottts/svg?seed=${seed}`;
            }
        }

        // Simpan Data
        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('p-name').value;
            const gender = document.getElementById('p-gender').value;
            const age = document.getElementById('p-age').value;
            const classRoom = document.getElementById('p-class').value;
            const address = document.getElementById('p-address').value;

            const yakin = await showConfirm("Simpan Profil", "Pastikan data yang Anda masukkan sudah benar.");
            
            if(yakin) {
                showLoading();
                try {
                    await db.collection('users').doc(uid).update({ 
                        name: name,
                        gender: gender,
                        age: age,
                        class_room: classRoom,
                        address: address
                    });
                    
                    // Update tampilan langsung
                    document.getElementById('display-name').textContent = name;
                    document.getElementById('incomplete-alert').classList.add('hidden'); // Sembunyikan alert jika sudah lengkap
                    
                    hideLoading();
                    await showAlert("Berhasil", "Data profil berhasil diperbarui!", "success");
                    
                } catch (err) {
                    hideLoading();
                    showAlert("Gagal", "Terjadi kesalahan saat menyimpan.", "error");
                }
            }
        }
    </script>
</body>
</html>
