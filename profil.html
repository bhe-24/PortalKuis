<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Saya - Cendekia Aksara</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* LAYOUT PROFIL */
        .profile-container {
            background: white; border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            padding: 40px; display: flex; gap: 40px;
            align-items: flex-start; margin-top: 20px;
        }
        .avatar-section { flex: 1; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .avatar-box {
            width: 180px; height: 180px; border-radius: 50%;
            overflow: hidden; border: 5px solid #f0f0f0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 20px;
            background-color: #e3f2fd; transition: 0.3s;
        }
        .avatar-box:hover { border-color: var(--primary); transform: scale(1.05); }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        
        .role-badge {
            background: var(--primary); color: white;
            padding: 5px 15px; border-radius: 50px;
            font-size: 0.9em; font-weight: 600; margin-top: 10px; display: inline-block;
        }
        .form-section { flex: 2; }
        .form-group label { font-size: 0.9em; color: #666; font-weight: 500; }
        .alert-box {
            background: #fff3cd; color: #856404; padding: 15px;
            border-radius: 10px; border: 1px solid #ffeeba; margin-bottom: 20px;
            font-size: 0.9em; display: flex; align-items: center; gap: 10px;
        }

        @media (max-width: 768px) {
            .profile-container { flex-direction: column; padding: 25px; }
            .avatar-section { width: 100%; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
            .form-section { width: 100%; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container nav-container">
            <div class="nav-brand">
                <img src="https://imgur.com/5Srjyo4.png" alt="Logo" class="nav-logo">
                <span class="brand-name">Cendekia Aksara</span>
            </div>
            <a href="dashboard.html" class="btn-logout" style="color: #333; border-color: #ddd;">
                <i class="fa-solid fa-arrow-left"></i> Kembali
            </a>
        </div>
    </nav>

    <div class="container dashboard-content">
        <div class="welcome-banner" style="background: linear-gradient(135deg, #43e97b, #38f9d7); padding: 30px;">
            <div class="welcome-text">
                <h1 style="margin: 0;">Profil Saya</h1>
                <p class="subtitle" style="color: #005a9c; opacity: 1;">Pastikan data diri Anda sudah benar.</p>
            </div>
            <div class="welcome-icon"><i class="fa-solid fa-id-card-clip" style="color: rgba(255,255,255,0.4);"></i></div>
        </div>

        <div class="profile-container">
            
            <div class="avatar-section">
                <div class="avatar-box">
                    <img id="avatar-img" src="https://api.dicebear.com/7.x/bottts/svg?seed=loading" alt="Avatar">
                </div>
                <h3 id="display-name" style="margin: 0;">Memuat...</h3>
                <span id="display-role" class="role-badge">SISWA</span>
                <p style="font-size: 0.8em; color: gray; margin-top: 10px;">Avatar otomatis dari sistem.</p>
            </div>

            <div class="form-section">
                
                <div id="incomplete-alert" class="alert-box hidden">
                    <i class="fa-solid fa-triangle-exclamation"></i>
                    <span><strong>Data Belum Lengkap!</strong> Harap isi Jenis Kelamin, Umur, dan Semester.</span>
                </div>

                <form id="profile-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Nama Lengkap</label>
                            <input type="text" id="p-name" class="modal-input-field" required>
                        </div>
                        <div class="form-group">
                            <label>Email (Akun)</label>
                            <input type="email" id="p-email" class="modal-input-field" disabled style="background:#f9f9f9; cursor:not-allowed;">
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px dashed #ddd; margin: 10px 0 20px 0;">

                    <div class="form-group">
                        <label>Jenis Kelamin <span style="color:red">*</span></label>
                        <select id="p-gender" class="modal-input-field" required onchange="updateAvatar(this.value)">
                            <option value="" disabled selected>-- Pilih --</option>
                            <option value="Laki-laki">Laki-laki</option>
                            <option value="Perempuan">Perempuan</option>
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Umur (Tahun) <span style="color:red">*</span></label>
                            <input type="number" id="p-age" class="modal-input-field" placeholder="Contoh: 17" required min="5" max="99">
                        </div>
                        
                        <div class="form-group">
                            <label>Semester Saat Ini <span style="color:red">*</span></label>
                            <select id="p-semester" class="modal-input-field" required>
                                <option value="" disabled selected>-- Pilih Semester --</option>
                                <option value="Semester 1">Semester 1</option>
                                <option value="Semester 2">Semester 2</option>
                                <option value="Semester 3">Semester 3</option>
                                <option value="Semester 4">Semester 4</option>
                                <option value="Semester 5">Semester 5</option>
                                <option value="Semester 6">Semester 6</option>
                                <option value="Semester 7">Semester 7</option>
                                <option value="Semester 8">Semester 8</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Alamat / Kota</label>
                        <input type="text" id="p-address" class="modal-input-field" placeholder="Contoh: Yogyakarta">
                    </div>

                    <button type="submit" class="btn btn-primary" style="margin-top: 10px; width: 100%;">
                        <i class="fa-solid fa-floppy-disk"></i> SIMPAN PERMANEN
                    </button>
                </form>
            </div>

        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let uid = null;
        
        auth.onAuthStateChanged(async user => {
            if(!user) { window.location.href = 'index.html'; return; }
            uid = user.uid;
            
            showLoading(); // Blur Effect

            try {
                const doc = await db.collection('users').doc(uid).get();
                if(doc.exists) {
                    const data = doc.data();
                    
                    // Isi Form
                    document.getElementById('p-email').value = data.email || '';
                    document.getElementById('p-name').value = data.name || '';
                    document.getElementById('display-name').textContent = data.name || 'Siswa';
                    document.getElementById('display-role').textContent = (data.role || 'SISWA').toUpperCase();

                    // Load Data Tersimpan (Permanen)
                    if(data.gender) document.getElementById('p-gender').value = data.gender;
                    if(data.age) document.getElementById('p-age').value = data.age;
                    if(data.address) document.getElementById('p-address').value = data.address;
                    
                    // Load Semester
                    if(data.semester) {
                        document.getElementById('p-semester').value = data.semester;
                    }

                    // Update Avatar
                    updateAvatar(data.gender);

                    // Cek Kelengkapan Data (Wajib Semester, Umur, Gender)
                    if (!data.gender || !data.age || !data.semester) {
                        document.getElementById('incomplete-alert').classList.remove('hidden');
                        
                        // POP UP WAJIB ISI
                        await showAlert(
                            "Lengkapi Profil", 
                            "Mohon lengkapi data <b>Jenis Kelamin, Umur, dan Semester</b> agar data Anda tersimpan permanen.", 
                            "info"
                        );
                    }
                }
            } catch (err) {
                console.error(err);
                showAlert("Error", "Gagal memuat profil.", "error");
            } finally {
                hideLoading();
            }
        });

        // FUNGSI AVATAR BARU (FIX PEREMPUAN)
        function updateAvatar(gender) {
            const imgEl = document.getElementById('avatar-img');
            // Gunakan UID sebagai seed agar gambar konsisten per user
            let seed = uid ? uid : 'randomseed'; 
            
            if (gender === 'Laki-laki') {
                // Cowok: Rambut pendek
                imgEl.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&top=shortHair,shortFlat,shortRound,shavedSides&hairColor=2c1b18`;
            } else if (gender === 'Perempuan') {
                // Cewek: Rambut Panjang (Dipaksa pakai parameter 'top')
                imgEl.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${seed}&top=longHair,straight01,straight02,bun,curvy&hairColor=2c1b18&clothe=blazerAndShirt`;
            } else {
                // Netral
                imgEl.src = `https://api.dicebear.com/7.x/bottts/svg?seed=${seed}`;
            }
        }

        // SIMPAN PERMANEN
        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('p-name').value;
            const gender = document.getElementById('p-gender').value;
            const age = document.getElementById('p-age').value;
            const semester = document.getElementById('p-semester').value;
            const address = document.getElementById('p-address').value;

            const yakin = await showConfirm("Simpan Permanen?", "Data yang disimpan akan menjadi data tetap Anda.");
            
            if(yakin) {
                showLoading();
                try {
                    // Update ke Firebase (Permanen)
                    await db.collection('users').doc(uid).update({ 
                        name: name,
                        gender: gender,
                        age: age,
                        semester: semester, // Simpan Semester
                        address: address
                    });
                    
                    document.getElementById('display-name').textContent = name;
                    document.getElementById('incomplete-alert').classList.add('hidden');
                    updateAvatar(gender); // Refresh avatar sesuai gender baru
                    
                    hideLoading();
                    await showAlert("Tersimpan!", "Data profil Anda aman dan tersimpan selamanya.", "success");
                    
                } catch (err) {
                    hideLoading();
                    showAlert("Gagal", "Terjadi kesalahan koneksi.", "error");
                }
            }
        }
    </script>
</body>
</html>
